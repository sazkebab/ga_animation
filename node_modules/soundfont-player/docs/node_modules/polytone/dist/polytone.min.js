(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){var Note=require("note-parser");var context=require("audio-context");var isAudioBuffer=require("is-audio-buffer");var midimessage=require("midimessage");function isFn(x){return typeof x==="function"}function isStr(x){return typeof x==="string"}function isNum(x){return typeof x==="number"}function isObj(x){return typeof x==="object"}function isDef(x){return typeof x!=="undefined"}var assign=Object.assign;function getTime(context,when,delay){return Math.max(context.currentTime,when||0)+(delay||0)}function Polytone(src,defaults){defaults=defaults?assign({},defaults):{};if(!defaults.context)defaults.context=context;var initialize=defaults.initialize;if(initialize)delete defaults["initialize"];var Source=AsSource(src,initialize);if(!Source)throw Error("Not valid source: "+src);var Player=SourcePlayer(Source);var maxVoices=defaults.maxVoices||0;if(isDef(defaults.maxVoices))delete defaults.maxVoices;var tracker=Tracker(maxVoices);var destination=defaults.destination||defaults.context.destination;var polytone={context:defaults.context,keys:Source.keys,start:function(options,when,delay,dur){var opts=prepareOptions(options,defaults);var node=Player(opts);if(!node)return null;if(destination)node.connect(destination);var time=getTime(opts.context,when,delay||opts.delay);tracker.track(time,node);node.start(time);dur=+dur||+opts.duration||0;if(dur)node.stop(time+dur);return node},connect:function(dest){destination=dest;return polytone},stop:function(when,delay,ids){var time=getTime(defaults.context,when,delay);ids=!ids?tracker.current():!Array.isArray(ids)?[ids]:ids;tracker.stop(time,ids);return polytone},on:function(name,cb){isFn(name)?tracker.addListener("*",name):tracker.addListener(name,cb);return polytone},schedule:function(events,when,delay){var time=getTime(polytone.context,when,delay);events.forEach(function(event){if(event)polytone.start(event,time+event.time)})},listenToMidi:listenToMidi(polytone)};return polytone}Polytone.with=function(options){return function(source){return Polytone(source,options)}};function prepareOptions(options,defaults){var opts=!options?defaults:isStr(options)?assign({name:options},defaults):isNum(options)?assign({midi:options},defaults):assign({},options,defaults);var note=Note.parse(opts.name||opts.note);if(!opts.note&&note)opts.note=Note.build(note);if(!opts.midi&&note)opts.midi=note.midi;if(!opts.frequency&&opts.midi)opts.frequency=Math.pow(2,(opts.midi-69)/12)*440;if(!opts.detune){opts.detune=Math.floor(opts.midi%1*100);if(opts.detune)opts.midi=Math.floor(opts.midi)}return opts}function velToGain(vel){return vel/127}function listenToMidi(polytone){return function(input,channel){var started={};input.onmidimessage=function(msg){var mm=msg.messageType?msg:midimessage(msg);if(isNum(channel)&&channel!==mm.channel)return;if(mm.messageType==="noteon"&&mm.velocity===0){mm.messageType="noteoff"}if(mm.messageType==="noteon"){started[mm.key]=polytone.start(mm.key,0,{gain:velToGain(mm.velocity)})}else if(mm.messageType==="noteoff"&&started[mm.key]){started[mm.key].stop();delete started[mm.key]}};return polytone}}function Tracker(maxVoices){var nextId=0;var emit=null;var tracked={};var currentVoice=0;var voices=Array(maxVoices);return{addListener:function(name,cb){var prev=emit;emit=function(event,time,node){if(prev)prev(event,time,node);if(name==="*"||name==="event")cb(event,time,node)}},track:function(time,node){node.id=node.id||nextId++;tracked[node.id]=node;controlLifecycle(node,emit);if(maxVoices){if(voices[currentVoice]){voices[currentVoice].stop(time)}voices[currentVoice]=node;currentVoice=(currentVoice+1)%maxVoices}return node},stop:function(time,ids){ids.forEach(function(id){tracked[id].stop(time)})},current:function(){return Object.keys(tracked)}}}function controlLifecycle(node,emit){var raw={connect:node.connect,disconnect:node.disconnect,start:node.start,stop:node.stop};node.connect=function(dest){if(emit)emit("connect",node.context.currentTime,node);raw.connect(dest);return node};node.start=function(time){if(emit)emit("start",time,node);raw.start(time);return node};node.stop=function(time){if(emit)emit("stop",time,node);raw.stop(time)};node.disconnect=function(dest){if(emit)emit("disconnect",node.context.currentTime,node);raw.disconnect()};node.onended=function(){if(emit)emit("ended",node.context.currentTime,node);setTimeout(node.disconnect,200)}}function SourcePlayer(Source){if(!Source)return null;return function(opts){var node={context:opts.context,source:Source(opts)};if(!node.source)return;node.output=node.source;var state="init";if(opts.attack||opts.release){node.env=opts.context.createGain();node.output.connect(node.env);node.output=node.env}if(opts.filter){node.filter=opts.context.createBiquadFilter();if(opts.filter.type)node.filter.type=opts.filter.type;if(opts.filter.frequency)node.filter.frequency.value=opts.filter.frequency;if(opts.filter.Q)node.filter.Q.value=opts.filter.Q;node.output.connect(node.filter);node.output=node.filter}if(isNum(opts.gain)){node.gain=opts.context.createGain();node.gain.gain.value=opts.gain;node.output.connect(node.gain);node.output=node.gain}node.start=function(time){if(state!=="init")return;state="started";node.source.start(time);if(opts.attack){node.env.gain.setValueAtTime(0,time);node.env.gain.linearRampToValueAtTime(1,time+opts.attack)}else if(node.env){node.env.gain.setValueAtTime(1,time)}return node};node.stop=function(time){if(state!=="started")return;state="stoped";time=time||node.conect.currentTime;var release=opts.release||0;if(release){node.env.gain.linearRampToValueAtTime(0,time+release)}node.source.stop(time+release)};node.connect=function(dest){node.output.connect(dest);return node};node.disconnect=function(){node.source.disconnect();if(node.env)node.env.disconnect();if(node.filter)node.filter.disconnect();if(node.gain)node.gain.disconnect()};return node}}function AsSource(src,init){return isFn(src)?src:isAudioBuffer(src)?BufferSource(src):isStr(src)?OscillatorSource(src):isObj(src)?ObjectSource(src,init):null}function BufferSource(buffer){return function(options){var source=options.context.createBufferSource();source.buffer=buffer;if(options.detune)source.detune.value=options.detune;if(options.loop===true)source.loop=true;return source}}function OscillatorSource(oscType){return function(options){var osc=options.context.createOscillator();osc.type=options.type||options.oscType||oscType;if(options.frequency)osc.frequency.value=options.frequency;if(options.detune)osc.detune=options.detune;return osc}}function ObjectSource(object,init){var keys=Object.keys(object);var midified=keys.reduce(function(midified,name){var raw=object[name];var value=init?function(options){return init(raw,options)}:isAudioBuffer(raw)?BufferSource(raw):isStr(raw)?OscillatorSource(raw):raw;var note=Note.parse(name);if(note)midified[note.midi]=value;else midified[name]=value;return midified},{});function select(options){var source=midified[options.midi]||midified[options.note]||midified[options.name];return source?source(options):null}select.keys=keys;return select}module.exports=Polytone},{"audio-context":2,"is-audio-buffer":4,midimessage:5,"note-parser":6}],2:[function(require,module,exports){var window=require("global/window");var Context=window.AudioContext||window.webkitAudioContext;if(Context)module.exports=new Context},{"global/window":3}],3:[function(require,module,exports){(function(global){if(typeof window!=="undefined"){module.exports=window}else if(typeof global!=="undefined"){module.exports=global}else{module.exports={}}}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],4:[function(require,module,exports){module.exports=function isAudioBuffer(buffer){return buffer!=null&&buffer.sampleRate!=null&&typeof buffer.getChannelData==="function"}},{}],5:[function(require,module,exports){(function(global){(function(e){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=e()}else if(typeof define==="function"&&define.amd){define([],e)}else{var t;if(typeof window!=="undefined"){t=window}else if(typeof global!=="undefined"){t=global}else if(typeof self!=="undefined"){t=self}else{t=this}t.midimessage=e()}})(function(){var e,t,s;return function o(e,t,s){function a(n,i){if(!t[n]){if(!e[n]){var l=typeof require=="function"&&require;if(!i&&l)return l(n,!0);if(r)return r(n,!0);var h=new Error("Cannot find module '"+n+"'");throw h.code="MODULE_NOT_FOUND",h}var c=t[n]={exports:{}};e[n][0].call(c.exports,function(t){var s=e[n][1][t];return a(s?s:t)},c,c.exports,o,e,t,s)}return t[n].exports}var r=typeof require=="function"&&require;for(var n=0;n<s.length;n++)a(s[n]);return a}({1:[function(e,t,s){"use strict";Object.defineProperty(s,"__esModule",{value:true});s["default"]=function(e){function t(e){this._event=e;this._data=e.data;this.receivedTime=e.receivedTime;if(this._data&&this._data.length<2){console.warn("Illegal MIDI message of length",this._data.length);return}this._messageCode=e.data[0]&240;this.channel=e.data[0]&15;switch(this._messageCode){case 128:this.messageType="noteoff";this.key=e.data[1]&127;this.velocity=e.data[2]&127;break;case 144:this.messageType="noteon";this.key=e.data[1]&127;this.velocity=e.data[2]&127;break;case 160:this.messageType="keypressure";this.key=e.data[1]&127;this.pressure=e.data[2]&127;break;case 176:this.messageType="controlchange";this.controllerNumber=e.data[1]&127;this.controllerValue=e.data[2]&127;if(this.controllerNumber===120&&this.controllerValue===0){this.channelModeMessage="allsoundoff"}else if(this.controllerNumber===121){this.channelModeMessage="resetallcontrollers"}else if(this.controllerNumber===122){if(this.controllerValue===0){this.channelModeMessage="localcontroloff"}else{this.channelModeMessage="localcontrolon"}}else if(this.controllerNumber===123&&this.controllerValue===0){this.channelModeMessage="allnotesoff"}else if(this.controllerNumber===124&&this.controllerValue===0){this.channelModeMessage="omnimodeoff"}else if(this.controllerNumber===125&&this.controllerValue===0){this.channelModeMessage="omnimodeon"}else if(this.controllerNumber===126){this.channelModeMessage="monomodeon"}else if(this.controllerNumber===127){this.channelModeMessage="polymodeon"}break;case 192:this.messageType="programchange";this.program=e.data[1];break;case 208:this.messageType="channelpressure";this.pressure=e.data[1]&127;break;case 224:this.messageType="pitchbendchange";var t=e.data[2]&127;var s=e.data[1]&127;this.pitchBend=(t<<8)+s;break}}return new t(e)};t.exports=s["default"]},{}]},{},[1])(1)})}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],6:[function(require,module,exports){"use strict";function fillStr(s,num){return Array(num+1).join(s)}function isNum(x){return typeof x==="number"}function isStr(x){return typeof x==="string"}function isDef(x){return typeof x!=="undefined"}function midiToFreq(midi,tuning){return Math.pow(2,(midi-69)/12)*(tuning||440)}var REGEX=/^([a-gA-G])(#{1,}|b{1,}|x{1,}|)(-?\d*)\s*(.*)\s*$/;function regex(){return REGEX}var SEMITONES=[0,2,4,5,7,9,11];function parse(str,isTonic,tuning){if(typeof str!=="string")return null;var m=REGEX.exec(str);if(!m||!isTonic&&m[4])return null;var p={letter:m[1].toUpperCase(),acc:m[2].replace(/x/g,"##")};p.pc=p.letter+p.acc;p.step=(p.letter.charCodeAt(0)+3)%7;p.alt=p.acc[0]==="b"?-p.acc.length:p.acc.length;var pos=SEMITONES[p.step]+p.alt;p.chroma=pos<0?12+pos:pos%12;if(m[3]){p.oct=+m[3];p.midi=pos+12*(p.oct+1);p.freq=midiToFreq(p.midi,tuning)}if(isTonic)p.tonicOf=m[4];return p}var LETTERS="CDEFGAB";function acc(n){return!isNum(n)?"":n<0?fillStr("b",-n):fillStr("#",n)}function oct(n){return!isNum(n)?"":""+n}function build(s,a,o){if(s===null||typeof s==="undefined")return null;if(s.step)return build(s.step,s.alt,s.oct);if(s<0||s>6)return null;return LETTERS.charAt(s)+acc(a)+oct(o)}function midi(note){if((isNum(note)||isStr(note))&&note>=0&&note<128)return+note;var p=parse(note);return p&&isDef(p.midi)?p.midi:null}function freq(note,tuning){var m=midi(note);return m===null?null:midiToFreq(m,tuning)}var parser={parse:parse,build:build,regex:regex,midi:midi,freq:freq};var FNS=["letter","acc","pc","step","alt","chroma","oct"];FNS.forEach(function(name){parser[name]=function(src){var p=parse(src);return p&&isDef(p[name])?p[name]:null}});module.exports=parser},{}]},{},[1]);